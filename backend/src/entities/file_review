use diesel::{Insertable, Queryable, PgConnection, QueryDsl, insert_into, expression::functions::sql_function};
use serde::{Serialize, Deserialize};
use uuid::Uuid;
use crate::schema::file_reviews::{self, file_id};
use diesel::prelude::*;
use super::error::UnishareError;

#[derive(Debug, Serialize, Deserialize, Insertable, Queryable)]
#[diesel(table_name = file_reviews)]
pub struct FileReview {
    pub reviewer_id: Uuid,
    pub file_id: Uuid,
    pub review: i32,
    pub comment: Option<String>
}

impl FileReview {

    // Get all reviews of some file
    pub async fn by_uuid(id: Uuid, db_conn: &mut PgConnection) -> Result<Vec<FileReview>, UnishareError> {
        let reviews_opt = file_reviews::table.filter(file_id.eq(id)).load::<FileReview>(db_conn).optional()?;
        if let Some(v) = reviews_opt {
            Ok(v)
        } else {
            Ok(vec![])
        }
    }

    // Add a review for a file
    pub async fn add_review(review: FileReview, db_conn: &mut PgConnection) -> Result<FileReview, UnishareError> {
        let inserted_opt = insert_into(file_reviews::table).values(review).get_result::<FileReview>(db_conn)?;

        Ok(inserted_opt)
    }

    // Get average rating if the file
    pub async fn get_average(file_id: Uuid, db_conn: &mut PgConnection) -> Result<f64, diesel::result::Error> {
        let average = file_reviews::table
        .select(avg(file_reviews::review))
        .filter(file_reviews::file_id.eq(file_id))
        .first(db_conn)
        .optional()?;
        Ok(average.unwrap_or(0.0))
    }

}